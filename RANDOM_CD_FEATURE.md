# éšæœº CD åŠŸèƒ½è¯´æ˜

## åŠŸèƒ½æ¦‚è¿°

ä¸ºæœªåœ¨æ•°æ®åº“ä¸­æ‰¾åˆ°çš„è‹±é›„è‡ªåŠ¨åˆ†é…éšæœº CD æ—¶é—´ï¼Œå¹¶ä¿æŒä¸å˜ã€‚

## æ–°å¢åŠŸèƒ½

### 1. è‹±é›„åå­—æ˜¾ç¤ºç­–ç•¥

**ä¹‹å‰çš„è¡Œä¸ºï¼š**
- å¦‚æœè‹±é›„åœ¨ `hero_spec.json` ä¸­æ‰¾ä¸åˆ° â†’ æ˜¾ç¤º"è‹±é›„1"è‡³"è‹±é›„5"
- CD ä¸º 0ï¼Œä¸å¯åŠ¨å€’è®¡æ—¶

**ç°åœ¨çš„è¡Œä¸ºï¼š**
- âœ… æ€»æ˜¯æ˜¾ç¤ºæœåŠ¡å™¨è¯†åˆ«å‡ºçš„è‹±é›„åå­—ï¼ˆå³ä½¿åœ¨æ•°æ®åº“ä¸­æ‰¾ä¸åˆ°ï¼‰
- âœ… å¦‚æœè‹±é›„ä¸åœ¨ `hero_spec.json` ä¸­ â†’ è‡ªåŠ¨åˆ†é… 20-50 ç§’çš„éšæœº CD
- âœ… éšæœº CD ä¼šè¢«ç¼“å­˜ï¼ŒåŒä¸€ä¸ªè‹±é›„çš„ CD ä¿æŒä¸å˜
- âœ… åªæœ‰æœåŠ¡å™¨è¿”å›å°‘äº5ä¸ªè‹±é›„æ—¶ï¼Œæ‰ä½¿ç”¨"è‹±é›„1"ç­‰é»˜è®¤åå­—

### 2. éšæœº CD ç”Ÿæˆæœºåˆ¶

#### è§¦å‘æ¡ä»¶
éšæœº CD ä¼šåœ¨ä»¥ä¸‹æƒ…å†µä¸‹ç”Ÿæˆï¼š

1. **è‹±é›„ä¸åœ¨æ•°æ®åº“ä¸­**
   ```kotlin
   // ä¾‹å¦‚ï¼šæœåŠ¡å™¨è¯†åˆ«å‡º"æ–°è‹±é›„"ï¼Œä½† hero_spec.json ä¸­æ²¡æœ‰
   // è‡ªåŠ¨åˆ†é…éšæœº CDï¼š35ç§’ï¼ˆä¸¾ä¾‹ï¼‰
   ```

2. **è‹±é›„çš„ CD æ•°æ®ä¸ºç©ºæˆ– 0**
   ```kotlin
   // ä¾‹å¦‚ï¼šhero_spec.json ä¸­æœ‰è‹±é›„ï¼Œä½† skill4_cooldown ä¸ºç©º
   // è‡ªåŠ¨åˆ†é…éšæœº CDï¼š42ç§’ï¼ˆä¸¾ä¾‹ï¼‰
   ```

3. **CD æ•°æ®è§£æå¤±è´¥**
   ```kotlin
   // ä¾‹å¦‚ï¼šskill4_cooldown æ ¼å¼å¼‚å¸¸
   // è‡ªåŠ¨åˆ†é…éšæœº CDï¼š28ç§’ï¼ˆä¸¾ä¾‹ï¼‰
   ```

#### éšæœºèŒƒå›´
- **æœ€å°å€¼**: 20 ç§’
- **æœ€å¤§å€¼**: 50 ç§’
- **åˆ†å¸ƒ**: å‡åŒ€éšæœº

#### ç¼“å­˜æœºåˆ¶
```kotlin
// ç¬¬ä¸€æ¬¡é‡åˆ°"æ–°è‹±é›„" â†’ ç”Ÿæˆéšæœº CD: 35ç§’
unknownHeroCdCache["æ–°è‹±é›„"] = 35

// ä»¥åæ¯æ¬¡ä½¿ç”¨"æ–°è‹±é›„" â†’ ç›´æ¥ä½¿ç”¨ç¼“å­˜: 35ç§’
// ä¸ä¼šé‡æ–°ç”Ÿæˆï¼Œä¿æŒä¸€è‡´
```

### 3. æ—¥å¿—è¾“å‡º

#### æ‰¾åˆ°è‹±é›„
```
D/FloatingWindow: è‹±é›„ 1: å»‰é¢‡ âœ… (åœ¨æ•°æ®åº“ä¸­æ‰¾åˆ°)
D/HeroDataManager: è‹±é›„ å»‰é¢‡ çš„å¤§æ‹› CD: 54ç§’
D/FloatingWindow: ğŸš€ å¯åŠ¨ å»‰é¢‡ çš„å¤§æ‹›å€’è®¡æ—¶: 54ç§’
```

#### æœªæ‰¾åˆ°è‹±é›„ï¼ˆç”Ÿæˆéšæœº CDï¼‰
```
W/FloatingWindow: è‹±é›„ 2: æ–°è‹±é›„X âš ï¸ (æœªåœ¨æ•°æ®åº“ä¸­æ‰¾åˆ°ï¼Œå°†ä½¿ç”¨éšæœº CD)
W/HeroDataManager: æœªæ‰¾åˆ°è‹±é›„: æ–°è‹±é›„X çš„å¤§æ‹›æ•°æ®ï¼Œåˆ†é…éšæœº CD: 38ç§’
D/FloatingWindow: ğŸš€ å¯åŠ¨ æ–°è‹±é›„X çš„å¤§æ‹›å€’è®¡æ—¶: 38ç§’
```

#### ä½¿ç”¨ç¼“å­˜çš„éšæœº CD
```
W/FloatingWindow: è‹±é›„ 2: æ–°è‹±é›„X âš ï¸ (æœªåœ¨æ•°æ®åº“ä¸­æ‰¾åˆ°ï¼Œå°†ä½¿ç”¨éšæœº CD)
D/HeroDataManager: æœªæ‰¾åˆ°è‹±é›„: æ–°è‹±é›„Xï¼Œä½¿ç”¨ç¼“å­˜çš„éšæœº CD: 38ç§’
D/FloatingWindow: ğŸš€ å¯åŠ¨ æ–°è‹±é›„X çš„å¤§æ‹›å€’è®¡æ—¶: 38ç§’
```

## æŠ€æœ¯å®ç°

### HeroDataManager.kt

#### 1. æ·»åŠ ç¼“å­˜æ˜ å°„
```kotlin
// æœªæ‰¾åˆ°è‹±é›„çš„éšæœº CD ç¼“å­˜ (è‹±é›„å -> éšæœºCD)
private val unknownHeroCdCache = mutableMapOf<String, Int>()
```

#### 2. ä¿®æ”¹ getHeroUltimateCd æ–¹æ³•
```kotlin
fun getHeroUltimateCd(heroName: String): Int {
    val heroSpec = heroSpecMap[heroName]
    
    if (heroSpec == null) {
        // æ£€æŸ¥ç¼“å­˜
        if (unknownHeroCdCache.containsKey(heroName)) {
            return unknownHeroCdCache[heroName]!!
        } else {
            // ç”Ÿæˆå¹¶ç¼“å­˜éšæœº CD
            val randomCd = (20..50).random()
            unknownHeroCdCache[heroName] = randomCd
            return randomCd
        }
    }
    
    // ... è§£æå®é™… CD
}
```

### FloatingWindowService.kt

#### ä¿®æ”¹ updateHeroes æ–¹æ³•
```kotlin
private fun updateHeroes(heroes: List<String>) {
    for (i in 0 until 5) {
        if (i < heroes.size) {
            val heroName = heroes[i]
            // æ€»æ˜¯ä½¿ç”¨è¯†åˆ«åˆ°çš„è‹±é›„åå­—
            currentHeroes.add(heroName)
            
            if (heroDataManager.hasHero(heroName)) {
                Log.d(TAG, "è‹±é›„ ${i+1}: $heroName âœ… (åœ¨æ•°æ®åº“ä¸­æ‰¾åˆ°)")
            } else {
                Log.w(TAG, "è‹±é›„ ${i+1}: $heroName âš ï¸ (æœªåœ¨æ•°æ®åº“ä¸­æ‰¾åˆ°ï¼Œå°†ä½¿ç”¨éšæœº CD)")
            }
        } else {
            // åªæœ‰æœåŠ¡å™¨è¿”å›å°‘äº5ä¸ªè‹±é›„æ—¶æ‰ä½¿ç”¨é»˜è®¤åå­—
            currentHeroes.add("è‹±é›„${i+1}")
        }
    }
}
```

#### ç®€åŒ–å€’è®¡æ—¶å¯åŠ¨é€»è¾‘
```kotlin
private fun startUltimateCountdown(heroIndex: Int, cdButtonId: Int) {
    val heroName = currentHeroes[heroIndex]
    val cdSeconds = heroDataManager.getHeroUltimateCd(heroName)
    
    // ä¸å†æ£€æŸ¥ cdSeconds <= 0ï¼Œå› ä¸ºæ€»ä¼šè¿”å›æœ‰æ•ˆå€¼
    Log.d(TAG, "ğŸš€ å¯åŠ¨ $heroName çš„å¤§æ‹›å€’è®¡æ—¶: ${cdSeconds}ç§’")
    startCountdownWithDuration(cdButtonId, cdSeconds)
}
```

## ä½¿ç”¨ç¤ºä¾‹

### åœºæ™¯1ï¼šæ‰€æœ‰è‹±é›„éƒ½åœ¨æ•°æ®åº“ä¸­
```
è¯†åˆ«ç»“æœ: ["å»‰é¢‡", "å…¸éŸ¦", "å®‰çªæ‹‰", "é²ç­ä¸ƒå·", "ç‘¶"]
æ˜¾ç¤º: å»‰é¢‡(54ç§’), å…¸éŸ¦(30ç§’), å®‰çªæ‹‰(20ç§’), é²ç­ä¸ƒå·(40ç§’), ç‘¶(15ç§’)
```

### åœºæ™¯2ï¼šéƒ¨åˆ†è‹±é›„ä¸åœ¨æ•°æ®åº“ä¸­
```
è¯†åˆ«ç»“æœ: ["å»‰é¢‡", "æ–°è‹±é›„A", "å®‰çªæ‹‰", "æ–°è‹±é›„B", "ç‘¶"]
æ˜¾ç¤º: å»‰é¢‡(54ç§’), æ–°è‹±é›„A(35ç§’), å®‰çªæ‹‰(20ç§’), æ–°è‹±é›„B(42ç§’), ç‘¶(15ç§’)

# ä¸‹æ¬¡é‡åˆ°ç›¸åŒè‹±é›„
è¯†åˆ«ç»“æœ: ["æ–°è‹±é›„A", "å…¸éŸ¦", ...]
æ˜¾ç¤º: æ–°è‹±é›„A(35ç§’ - ä½¿ç”¨ç¼“å­˜), å…¸éŸ¦(30ç§’), ...
```

### åœºæ™¯3ï¼šæœåŠ¡å™¨åªè¿”å›3ä¸ªè‹±é›„
```
è¯†åˆ«ç»“æœ: ["å»‰é¢‡", "å…¸éŸ¦", "å®‰çªæ‹‰"]
æ˜¾ç¤º: å»‰é¢‡(54ç§’), å…¸éŸ¦(30ç§’), å®‰çªæ‹‰(20ç§’), è‹±é›„4(é»˜è®¤), è‹±é›„5(é»˜è®¤)
```

### åœºæ™¯4ï¼šè‹±é›„CDä¸º0æˆ–ç©º
```
hero_spec.json ä¸­ï¼š
{
  "name": "æ˜ä¸–éš",
  "skill4_cooldown": ""  // æˆ– "0"
}

è¯†åˆ«ç»“æœ: ["æ˜ä¸–éš", ...]
æ˜¾ç¤º: æ˜ä¸–éš(28ç§’ - éšæœºç”Ÿæˆ), ...
```

## ä¼˜åŠ¿

1. âœ… **æ›´å¥½çš„ç”¨æˆ·ä½“éªŒ**: æ€»æ˜¯æ˜¾ç¤ºè¯†åˆ«å‡ºçš„è‹±é›„åå­—ï¼Œä¸ä¼šå‡ºç°"è‹±é›„1"ç­‰å ä½ç¬¦
2. âœ… **å…¼å®¹æ–°è‹±é›„**: å³ä½¿æ¸¸æˆæ›´æ–°äº†æ–°è‹±é›„ï¼ŒApp ä¹Ÿèƒ½æ­£å¸¸å·¥ä½œ
3. âœ… **æ•°æ®ä¸€è‡´æ€§**: åŒä¸€ä¸ªè‹±é›„çš„éšæœº CD ä¿æŒä¸å˜ï¼Œä¸ä¼šæ¯æ¬¡éƒ½å˜
4. âœ… **å¥å£®æ€§**: å³ä½¿æ•°æ®æ–‡ä»¶ä¸å®Œæ•´æˆ–æ ¼å¼é”™è¯¯ï¼Œä¹Ÿèƒ½æ­£å¸¸è¿è¡Œ
5. âœ… **å¯æ‰©å±•æ€§**: æœªæ¥å¯ä»¥è½»æ¾æ·»åŠ æŒä¹…åŒ–å­˜å‚¨ï¼ˆSharedPreferencesï¼‰ï¼Œè®©éšæœº CD åœ¨ App é‡å¯åä¹Ÿä¿æŒä¸å˜

## æœªæ¥æ”¹è¿›æ–¹å‘

### 1. æŒä¹…åŒ–å­˜å‚¨
```kotlin
// å°† unknownHeroCdCache ä¿å­˜åˆ° SharedPreferences
// è¿™æ ·å³ä½¿ App é‡å¯ï¼Œéšæœº CD ä¹Ÿä¸ä¼šæ”¹å˜
```

### 2. ç”¨æˆ·è‡ªå®šä¹‰ CD
```kotlin
// å…è®¸ç”¨æˆ·é•¿æŒ‰è‹±é›„åå­—ï¼Œæ‰‹åŠ¨è®¾ç½® CD æ—¶é—´
```

### 3. äº‘ç«¯æ•°æ®åŒæ­¥
```kotlin
// å®šæœŸä»æœåŠ¡å™¨åŒæ­¥æœ€æ–°çš„è‹±é›„æ•°æ®
// è‡ªåŠ¨æ›´æ–° hero_spec.json
```

## æ•°æ®æ–‡ä»¶æ›´æ–°

### hero_spec.json æ›´æ–°å†…å®¹
- æ·»åŠ äº†æ›´å¤šè‹±é›„æ•°æ®ï¼ˆä»åŸæ¥çš„çº¦100ä¸ªå¢åŠ åˆ°çº¦120+ä¸ªï¼‰
- åŒ…å«äº†æœ€æ–°çš„è‹±é›„ä¿¡æ¯
- ä½ç½®: `/Users/lr90/andro/app/src/main/assets/hero_spec.json`

### å¦‚ä½•æ›´æ–°æ•°æ®æ–‡ä»¶
```bash
# 1. ç¼–è¾‘ data/hero_spec.json
# 2. å¤åˆ¶åˆ° assets ç›®å½•
cp data/hero_spec.json app/src/main/assets/hero_spec.json

# 3. é‡æ–°ç¼–è¯‘ App
```

## æµ‹è¯•å»ºè®®

### æµ‹è¯•1ï¼šå·²çŸ¥è‹±é›„
1. æˆªå–åŒ…å«"å»‰é¢‡"ã€"å…¸éŸ¦"ç­‰å·²çŸ¥è‹±é›„çš„æˆªå›¾
2. éªŒè¯è‹±é›„åå­—æ­£ç¡®æ˜¾ç¤º
3. éªŒè¯ CD æ—¶é—´ä¸ hero_spec.json ä¸­çš„ä¸€è‡´

### æµ‹è¯•2ï¼šæœªçŸ¥è‹±é›„
1. æ‰‹åŠ¨ä¿®æ”¹æœåŠ¡å™¨å“åº”ï¼Œè¿”å›ä¸€ä¸ªä¸å­˜åœ¨çš„è‹±é›„å"æµ‹è¯•è‹±é›„"
2. éªŒè¯"æµ‹è¯•è‹±é›„"è¢«æ­£ç¡®æ˜¾ç¤º
3. éªŒè¯åˆ†é…äº†éšæœº CDï¼ˆ20-50ç§’ï¼‰
4. å¤šæ¬¡ä½¿ç”¨è¯¥è‹±é›„ï¼ŒéªŒè¯ CD ä¿æŒä¸å˜

### æµ‹è¯•3ï¼šæ··åˆåœºæ™¯
1. æˆªå–åŒ…å«å·²çŸ¥å’ŒæœªçŸ¥è‹±é›„æ··åˆçš„æˆªå›¾
2. éªŒè¯æ‰€æœ‰è‹±é›„åå­—éƒ½æ­£ç¡®æ˜¾ç¤º
3. éªŒè¯å·²çŸ¥è‹±é›„ä½¿ç”¨çœŸå® CDï¼ŒæœªçŸ¥è‹±é›„ä½¿ç”¨éšæœº CD

## ç‰ˆæœ¬ä¿¡æ¯

- **åŠŸèƒ½ç‰ˆæœ¬**: v1.1
- **æ›´æ–°æ—¥æœŸ**: 2024-11-14
- **æ›´æ–°å†…å®¹**:
  - âœ… æ”¯æŒæœªçŸ¥è‹±é›„çš„éšæœº CD
  - âœ… éšæœº CD ç¼“å­˜æœºåˆ¶
  - âœ… æ€»æ˜¯æ˜¾ç¤ºè¯†åˆ«å‡ºçš„è‹±é›„åå­—
  - âœ… æ›´æ–° hero_spec.json æ•°æ®æ–‡ä»¶
  - âœ… æ·»åŠ  `android:usesCleartextTraffic="true"` æ”¯æŒ HTTP è¯·æ±‚

